name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-info:
    name: PR Information
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Check PR size
      id: pr_size
      run: |
        FILES_CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | wc -l)
        LINES_ADDED=$(git diff --numstat origin/${{ github.base_ref }}...HEAD | awk '{sum+=$1} END {print sum}')
        LINES_REMOVED=$(git diff --numstat origin/${{ github.base_ref }}...HEAD | awk '{sum+=$2} END {print sum}')

        echo "FILES_CHANGED=$FILES_CHANGED" >> $GITHUB_OUTPUT
        echo "LINES_ADDED=$LINES_ADDED" >> $GITHUB_OUTPUT
        echo "LINES_REMOVED=$LINES_REMOVED" >> $GITHUB_OUTPUT

    - name: Comment PR info
      uses: actions/github-script@v7
      with:
        script: |
          const filesChanged = '${{ steps.pr_size.outputs.FILES_CHANGED }}';
          const linesAdded = '${{ steps.pr_size.outputs.LINES_ADDED }}';
          const linesRemoved = '${{ steps.pr_size.outputs.LINES_REMOVED }}';

          let sizeLabel = 'ğŸŸ¢ Small PR';
          if (filesChanged > 20 || linesAdded > 500) {
            sizeLabel = 'ğŸ”´ Large PR';
          } else if (filesChanged > 10 || linesAdded > 200) {
            sizeLabel = 'ğŸŸ¡ Medium PR';
          }

          const comment = `## ğŸ“Š PR Statistics

          ${sizeLabel}

          - **Files Changed:** ${filesChanged}
          - **Lines Added:** ${linesAdded}
          - **Lines Removed:** ${linesRemoved}

          ---
          ğŸ¤– Auto-generated by GitHub Actions`;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

  test-pr:
    name: Test PR
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r v7.0/requirements.txt

    - name: Run tests
      run: |
        cd v7.0
        python -m unittest discover -s tests -p "test_*.py"

    - name: Comment test results
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          const testStatus = '${{ job.status }}' === 'success' ? 'âœ… All tests passed' : 'âŒ Tests failed';
          const comment = `## ${testStatus}

          Check the [Actions tab](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.

          ---
          ğŸ¤– Auto-generated by GitHub Actions`;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
